---
title: 'Plots - Lithic analysis Balver Höhle '
author: "Lisa Schunk"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    theme: cerulean
    highlight: pygments
    number_sections: true
  github_document: 
    toc: true
    toc_depth: 3
    html_preview: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all", 
  knit_root_dir = rprojroot::find_rstudio_root_file()) })
---


```{r Knitr Options, include = FALSE}
knitr::opts_chunk$set(comment = NA, message = FALSE, indent = "", error = TRUE)
```


---

# Goal of the script
This script reads the xlsx file (derived data) containing all the information gained through a lithic analysis.   
The script will:

1. Reads the xlsx file 
2. Plots all relevant variables in various combinations 
3. Saves the plot as PDFs


```{r}
dir_in <-  "analysis/Balve/derived_data/"
dir_out <- "analysis/Balve/plots/"
```

Raw data must be located in "`r dir_in`".  
Formatted data will be saved in "`r dir_out`".
The knit directory for this script is the project directory.

---


# Load packages
```{r}
library(openxlsx)
library(readxl)
library(R.utils)
library(tools)
library(chron)
library(ggplot2)
library(wesanderson)
library(dplyr)
library(ggsci)
```


---

# Get name, path and information of the file
```{r}
data_file <- list.files(dir_in, pattern = "\\.xlsx$", full.names = TRUE)
md5_in <- md5sum(data_file)
info_in <- data.frame(files = basename(names(md5_in)), checksum = md5_in, 
                      row.names = NULL)
```

The checksum (MD5 hashes) of the imported files are:  
```{r, echo = FALSE}
info_in
```


# Load data into R object
```{r}
imp_data <- read.xlsx(xlsxFile = data_file, sheet = 1, startRow = 1, colNames = TRUE,
                      rowNames = FALSE, skipEmptyRows = FALSE) 
```



# Data analsysis - plots  
## Histogram
### Histogram dimensions - Keilmesser 
```{r}
# Load data sheet Keilmesser 
KM_dim <- read.xlsx(xlsxFile = data_file, sheet = 3) 


# Histogram Keilmesser length
KM.length <- ggplot(KM_dim, aes(x = length, fill = artefact.state)) + 
             geom_histogram(binwidth = 1) + xlim(20, 160) +
             labs(x = "length [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
             theme_classic() +
             geom_vline(aes(xintercept=mean(length)), linetype="dashed", size=1) +
             scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = c("complete", "Keilmesser point", "semifinished product")) 

print(KM.length)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.length", ".pdf")
ggsave(filename = file_out, plot = KM.length, path = dir_out, device = "pdf")

# Histogram Keilmesser width
KM.width <- ggplot(KM_dim, aes(x = width, fill = artefact.state)) + 
            geom_histogram(binwidth = 1) + xlim(20, 90) +
            labs(x = "width [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
            theme_classic() +
            geom_vline(aes(xintercept=mean(width)), linetype="dashed", size=1) +
            scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = c("complete", "Keilmesser point", "semifinished product")) 

print(KM.width) 
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.width", ".pdf")
ggsave(filename = file_out, plot = KM.width, path = dir_out, device = "pdf")

# Histogram Keilmesser thickness 
KM.thickness  <- ggplot(KM_dim, aes(y = thickness, fill = artefact.state)) + 
                 geom_histogram(binwidth = 1) + ylim(5, 30) +
                 labs(y = "thickness [mm]", x = "N", title = "", fill = "artefact state", size = 12) +
                 theme_classic() +
                 geom_hline(aes(yintercept=mean(thickness)), linetype="dashed", size=1) +
                 scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = c("complete", "Keilmesser point", "semifinished product")) 

print(KM.thickness) 
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.thickness", ".pdf")
ggsave(filename = file_out, plot = KM.thickness, path = dir_out, device = "pdf")

# Weight
# Load data sheet Keilmesser weight
KM_weight <- read.xlsx(xlsxFile = data_file, sheet = 12) 

# Histogram Keilmesser weight
mean_weight <- mean(KM_weight$weight, na.rm = TRUE)
n <- doBy::summaryBy(weight ~ artefact.state, data = KM_weight, FUN = length)
tag <- gsub(pattern = "_", replacement = " ", paste0(n[[1]], " (N = ", n[[2]], ")"))


KM.weight <- ggplot(KM_weight, na.rm = FALSE, aes(y = weight, fill = artefact.state)) + 
             geom_histogram(binwidth = 0.005) +
             labs(y = "weight [kg]", x = "N", title = "", fill = "artefact state", size = 12) +
             theme_classic() +
             geom_hline(aes(yintercept=mean_weight), linetype="dashed", size=1) +
             geom_text(aes(y=mean_weight, x=2.9, label = round(mean_weight,3)), nudge_y = -0.001) +
             scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = tag) 

print(KM.weight)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.weight", ".pdf")
ggsave(filename = file_out, plot = KM.weight, path = dir_out, device = "pdf")

# Back 
# Load data sheet Keilmesser thickness back 
KM_back <- read.xlsx(xlsxFile = data_file, sheet = 22) 

# Histogram Keilmesser thickness back  
KM.back  <- ggplot(KM_back, aes(y = thickness.back, fill = artefact.state)) + 
                 geom_histogram(binwidth = 1) + ylim(5, 30) +
                 labs(y = "thickness [mm]", x = "N", title = "", fill = "artefact state", size = 12) +
                 theme_classic() +
                 geom_hline(aes(yintercept=mean(thickness.back)), linetype="dashed", size=1) +
                 scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = c("complete", "Keilmesser point", "semifinished product")) 

print(KM.back) 
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.back", ".pdf")
ggsave(filename = file_out, plot = KM.back, path = dir_out, device = "pdf")

```


### Histogram dimensions - Pradnick scraper 
```{r}
# Load data sheet Pradnick scraper  
PS_dim <- read.xlsx(xlsxFile = data_file, sheet = 7) 


# Histogram Pradnick scraper length
PS.length <- ggplot(PS_dim, aes(x = length, fill = artefact.state)) + 
             geom_histogram(binwidth = 1) + xlim(30, 80) +
             labs(x = "length [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
             theme_classic() +
             geom_vline(aes(xintercept=mean(length)), linetype="dashed", size=1) +
             scale_fill_manual(values = wes_palette(n =1,name = "FantasticFox1")) 

print(PS.length)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.length", ".pdf")
ggsave(filename = file_out, plot = PS.length, path = dir_out, device = "pdf")


# Histogram Pradnick scraper width
PS.width <- ggplot(PS_dim, aes(x = width, fill = artefact.state)) + 
            geom_histogram(binwidth = 1) + xlim(20, 50) +
            labs(x = "width [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
            theme_classic() +
            geom_vline(aes(xintercept=mean(width)), linetype="dashed", size=1) +
            scale_fill_manual(values = wes_palette(n =1,name = "FantasticFox1")) 
 
print(PS.width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.width", ".pdf")
ggsave(filename = file_out, plot = PS.width, path = dir_out, device = "pdf")



# Histogram Pradnick scraper thickness 
PS.thickness <- ggplot(PS_dim, aes(y = thickness, fill = artefact.state)) + 
                geom_histogram(binwidth = 1) + ylim(0, 25) +
                labs(y = "thickness [mm]", x = "N", title = "", fill = "artefact state", size = 12) +
                theme_classic() +
                geom_hline(aes(yintercept=mean(thickness)), linetype="dashed", size=1) +
                scale_fill_manual(values = wes_palette(n =1 ,name = "FantasticFox1")) 

print(PS.thickness)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.thickness", ".pdf")
ggsave(filename = file_out, plot = PS.thickness, path = dir_out, device = "pdf")


# Load data sheet Pradnick scraper weight
PS_weight <- read.xlsx(xlsxFile = data_file, sheet = 13) 

# Histogram Pradnick scraper weight
mean_weight <- mean(PS_weight$weight, na.rm = TRUE)
n <- doBy::summaryBy(weight ~ artefact.state, data = PS_weight, FUN = length)
tag <- gsub(pattern = "_", replacement = " ", paste0(n[[1]], " (N = ", n[[2]], ")"))

PS.weight <- ggplot(PS_weight, aes(y = weight, fill = artefact.state)) + 
             geom_histogram(binwidth = 0.001) + 
             labs(y = "weight [kg]", x = "N", title = "", fill = "artefact state", size = 12) +
             theme_classic() +
             geom_hline(aes(yintercept=mean_weight), linetype="dashed", size=1) +
             geom_text(aes(y=mean_weight, x=2.9, label = round(mean_weight,3)), nudge_y = -0.001) +
             scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = tag) 
print(PS.weight)

file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.weight", ".pdf")
ggsave(filename = file_out, plot = PS.weight, path = dir_out, device = "pdf")


# Back 
# Load data sheet Pradnick scraper thickness back 
PS_back <- read.xlsx(xlsxFile = data_file, sheet = 23) 

# Histogram Pradnick scraper thickness back  
PS.back  <- ggplot(PS_back, aes(y = thickness.back, fill = artefact.state)) + 
                 geom_histogram(binwidth = 1) + ylim(3, 20) +
                 labs(y = "thickness [mm]", x = "N", title = "", fill = "artefact state", size = 12) +
                 theme_classic() +
                 geom_hline(aes(yintercept=mean(thickness.back)), linetype="dashed", size=1) +
                 scale_fill_manual(values = wes_palette(n =3,name = "Zissou1"), labels = c("complete", "Keilmesser point", "semifinished product")) 

print(PS.back) 
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.back", ".pdf")
ggsave(filename = file_out, plot = PS.back, path = dir_out, device = "pdf")

```


### Histogram dimensions - Scraper 
```{r}
# Load data sheet Pradnick scraper  
S_dim <- read.xlsx(xlsxFile = data_file, sheet = 9) 


# Histogram scraper length
S.length <- ggplot(S_dim, aes(x = length, fill = artefact.state)) + 
            geom_histogram(binwidth = 1) + xlim(40, 100) +
            labs(x = "length [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
            theme_classic() +
            geom_vline(aes(xintercept=mean(length)), linetype="dashed", size=1) +
            scale_fill_manual(values = wes_palette(n =1,name = "Zissou1"))

print(S.length)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "S.length", ".pdf")
ggsave(filename = file_out, plot = S.length, path = dir_out, device = "pdf")


# Histogram scraper width
S.width <- ggplot(S_dim, aes(x = width, fill = artefact.state)) + 
           geom_histogram(binwidth = 1) + xlim(25, 50) +
           labs(x = "width [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
           theme_classic() +
           geom_vline(aes(xintercept=mean(width)), linetype="dashed", size=1) +
           scale_fill_manual(values = wes_palette(n =1,name = "Zissou1"))

print(S.width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "S.width", ".pdf")
ggsave(filename = file_out, plot = S.width, path = dir_out, device = "pdf")


# Histogram scraper thickness 
S.thickness <- ggplot(S_dim, aes(y = thickness, fill = artefact.state)) + 
               geom_histogram(binwidth = 1) + ylim(8, 25) +
               labs(y = "thickness [mm]", x = "N", title = "", fill = "artefact state", size = 12) +
               theme_classic() +
               geom_hline(aes(yintercept=mean(thickness)), linetype="dashed", size=1) +
               scale_fill_manual(values = wes_palette(n =1,name = "Zissou1"))

print(S.thickness)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "S.thickness", ".pdf")
ggsave(filename = file_out, plot = S.thickness, path = dir_out, device = "pdf")

# Load data sheet scraper weight
PS_weight <- read.xlsx(xlsxFile = data_file, sheet = 15) 

# Histogram scraper weight

```


### Histogram dimension - Lateral sharpening spall
```{r}
# Load data sheet lateral sharpening spall  
LSS_dim <- read.xlsx(xlsxFile = data_file, sheet = 8) 

  
# Histogram lateral sharpening spall length
LSS.length <- ggplot(LSS_dim, aes(x = length, fill = artefact.state)) + 
              geom_histogram(binwidth = 1) + xlim(5, 50) +
              labs(x = "length [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
              theme_classic() +
              geom_vline(aes(xintercept=mean(length)), linetype="dashed", size=1) +
              scale_fill_manual(values = wes_palette(n =3,name = "Darjeeling2"), labels = c("complete", "distal fragment", "medial fragment")) 

print(LSS.length)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "LSS.length", ".pdf")
ggsave(filename = file_out, plot = LSS.length, path = dir_out, device = "pdf")


# Histogram lateral sharpening spall width
LSS.width <- ggplot(LSS_dim, aes(x = width, fill = artefact.state)) + 
             geom_histogram(binwidth = 1) + xlim(10, 30) +
             labs(x = "width [mm]", y = "N", title = "", fill = "artefact state", size = 12) +
             theme_classic() +
             geom_vline(aes(xintercept=mean(width)), linetype="dashed", size=1) +
             scale_fill_manual(values = wes_palette(n =3,name = "Darjeeling2"), labels = c("complete", "distal fragment", "medial fragment")) 


print(LSS.width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "LSS.width", ".pdf")
ggsave(filename = file_out, plot = LSS.width, path = dir_out, device = "pdf")



# Histogram lateral sharpening spall thickness 
LSS.thickness <- ggplot(LSS_dim, aes(y = thickness, fill = artefact.state)) + 
                 geom_histogram(binwidth = 1) + ylim(2, 12) +
                 labs(y = "thickness[mm]", x = "N", title = "", fill = "artefact state", size = 12) +
                 theme_classic() + 
                 geom_hline(aes(yintercept=mean(thickness)), linetype="dashed", size=1) +
                 scale_fill_manual(values = wes_palette(n =3,name = "Darjeeling2"), labels = c("complete", "distal fragment", "medial fragment")) 

print(LSS.thickness)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "LSS.thickness", ".pdf")
ggsave(filename = file_out, plot = LSS.thickness, path = dir_out, device = "pdf")


# Load data sheet lateral sharpening spall weight
PS_weight <- read.xlsx(xlsxFile = data_file, sheet = 14) 

# Histogram lateral sharpening spall weight


```

## Scatterplot 
### Length-width ratio 
```{r}
# Load data sheet Keilmesser 
KM_comp_dim <- read.xlsx(xlsxFile = data_file, sheet = 6) 


# Scatterplot Keilmesser (complete + point) length VS width 
KM.length_width <- ggplot(KM_comp_dim, aes(y = length, x = width, fill = artefact.state)) +
                   geom_point(size = 3, shape = 21) +
                   labs(x = "length [mm]", y = "width [mm]", title = "", fill = "artefact state", size = 12) +
                   xlim(0, 150) + ylim(0, 150) +
                   theme_classic() +
                   scale_fill_manual(values = wes_palette(n =3,name = "Zissou1", type = "continuous"),labels = c("complete", "Keilmesser point")) 

print(KM.length_width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.length_width", ".pdf")
ggsave(filename = file_out, plot = KM.length_width, path = dir_out, device = "pdf")


# Scatterplot Pradnick scraper length VS width 
PS.length_width <- ggplot(PS_dim, aes(y = length, x = width, fill = artefact.state)) +
                   geom_point(size = 3, shape = 21) +
                   labs(x = "length [mm]", y = "width [mm]", title = "",fill = "artefact state", size = 12) +
                   xlim(10, 70) + ylim(30, 80) +
                   theme_classic() +
                   scale_fill_manual(values = wes_palette(n =1,name = "FantasticFox1", type = "continuous")) 

print(PS.length_width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.length_width", ".pdf")
ggsave(filename = file_out, plot = PS.length_width, path = dir_out, device = "pdf")


# Scatterplot lateral sharpening spall length VS width 
# Defines only the rows with complete LSS  
LSS.comp_dim <- LSS_dim[1:110,] 

LSS.length_width <- ggplot(LSS.comp_dim, aes(y = length, x = width, fill = artefact.state)) +
                    geom_point(size = 3, shape = 21) +
                    labs(x = "length [mm]", y = "width [mm]", title = "",fill = "artefact state", size = 12) +
                    xlim(0, 45) + ylim(0, 65) +
                    theme_classic() +
                    scale_fill_manual(values = wes_palette(n =1,name = "GrandBudapest1", type = "continuous")) 

print(LSS.length_width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "LSS.length_width", ".pdf")
ggsave(filename = file_out, plot = LSS.length_width, path = dir_out, device = "pdf")


# Scatterplot Keilmesser (complete) + Pradnick scraper length VS width
# Load data sheet dimensions  
dim <- read.xlsx(xlsxFile = data_file, sheet = 2) 

KM.PS_dim <- dim[c(1:191, 309:335), ]  %>% arrange(artefact.state)
KM.PS_dim <- KM.PS_dim[1:185,]

KM.PS.length_width <- ggplot(KM.PS_dim, aes(y = length, x = width, fill = technological.class)) +
                      geom_point(size = 3, shape = 21) +
                      labs(x = "length [mm]", y = "width [mm]", title = "",fill = "artefact type", size = 12) +
                      xlim(0, 140) + ylim(0, 150) +
                      theme_classic() +
                      scale_fill_manual(values = wes_palette(n =3,name = "GrandBudapest1", type = "continuous"), labels = c("Keilmesser", "Pradnick scraper")) 

print(KM.PS.length_width)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.PS.length_width", ".pdf")
ggsave(filename = file_out, plot = KM.PS.length_width, path = dir_out, device = "pdf")



# Scatterplot Keilmesser (complete): length-width combined with morpho type 

KM.width_length_morpho <- ggplot(KM_morpho.type, aes(y = length, x = width, fill = morpho.type)) +
                      geom_point(size = 2, shape = 21) +
                      labs(x = "length [mm]", y = "width [mm]", title = "", fill = "morpho type", size = 12) +
                      xlim(0, 100) + ylim(0, 150) +
                      theme_classic() +
                      scale_color_startrek()

print(KM.width_length_morpho)
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.width_length_morpho", ".pdf")
ggsave(filename = file_out, plot = KM.width_length_morpho, path = dir_out, device = "pdf")
```


## Barplot
### Morpho type 
```{r}
# Load data sheet Keilmesser morpho type 
KM_morpho.type <- read.xlsx(xlsxFile = data_file, sheet = 28)  

# Defines only the rows with complete Keilmesser  
KM_morpho.type <- KM_morpho.type[1:158,]

# Barplot Keilmesser morpho type 
KM.morpho.type <- ggplot(data = KM_morpho.type) + aes(x = morpho.type, fill = morpho.type) + 
     geom_bar(stat = "count") +
     theme_classic() +
     theme(legend.position = "none") + 
     labs(x = " ", y = "N") + 
     scale_fill_brewer(palette="Dark2")

print(KM.morpho.type)
```


## Ternary plot
### Perimeter
```{r}
library(ggtern)
# Perimeter Keilmesser 
# Load data sheet Keilmesser perimeter
KM_perimeter <- read.xlsx(xlsxFile = data_file, sheet = 10) 
# Defines only the rows with complete Keilmesser  
KM_perimeter <- KM_perimeter[1:158,]

# Ternary diagram Keilmesser perimeter
KM.perimeter  <- ggtern(data = KM_perimeter, aes(x = perimeter.arch, y = perimeter.active.edge, z = perimeter.basis.back)) +
                 geom_point(aes(colour = morpho.type)) +
                 theme_bw() +
                 scale_colour_startrek() +
                 theme_hidetitles() +
                 theme_showarrows() +
                 xlab("arch")+ 
                 ylab("active edge")+
                 zlab("basis + back")+ 
                 labs(colour = "morpho type") +
                 tern_limits(labels=c(0, 20, 40, 60, 80, 100)) +
                 theme_rotate(degrees = 330)
                

print(KM.perimeter) 
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "KM.perimeter", ".pdf")
ggsave(filename = file_out, plot = KM.perimeter, path = dir_out, device = "pdf")


# Perimeter Pradnick scraper
# Load data sheet Pradnick scraper perimeter
PS_perimeter <- read.xlsx(xlsxFile = data_file, sheet = 11) 

# Ternary diagram Pradnick scraper perimeter
PS.perimeter  <- ggtern(data = PS_perimeter, aes(x = perimeter.arch, y = perimeter.active.edge, z = perimeter.basis.back)) +
                 geom_point(aes(colour = morpho.type)) +
                 theme_bw() +
                 scale_colour_startrek() +
                 theme_hidetitles() +
                 theme_showarrows() +
                 xlab("arch")+ 
                 ylab("active edge")+
                 zlab("basis + back")+ 
                 labs(colour = "morpho type") +
                 tern_limits(labels=c(0, 20, 40, 60, 80, 100)) +
                 theme_rotate(degrees = 330)
                

print(PS.perimeter) 
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "PS.perimeter", ".pdf")
ggsave(filename = file_out, plot = PS.perimeter, path = dir_out, device = "pdf")

```


```




## Morpho type  
```{r}
# scatterplot Keilmesser (complete) + morpho types length VS width
KM.morpho.length_width <-  ggplot(KM_morpho.type, aes(y = length, x = width, fill = morpho.type)) +
   geom_point(size = 3, shape = 21) +
   labs(x = "length [mm]", y = "width [mm]", title = "",fill = "morpho type", size = 12) +
   xlim(0, 150) + ylim(0, 160) +
   theme_classic() +
   scale_fill_manual(values = wes_palette(n =7,name = "FantasticFox1", type = "continuous"), labels = c("Bockstein", "Balve", "Klausennische","Königsaue", "Pradnick", "Buhlen", "undeterminable")) 

ggsave("KM.morpho.length_width.png")


# scatterplot Pradnick scraper (complete) + morpho types length VS width
PS.morpho.length_width <-  ggplot(PS_morpho.type, aes(y = length, x = width, fill = morpho.type)) +
   geom_point(size = 3, shape = 21) +
   labs(x = "length [mm]", y = "width [mm]", title = "",fill = "morpho type", size = 12) +
   xlim(0, 80) + ylim(20, 80) +
   theme_classic() +
   scale_fill_manual(values = wes_palette(n =7,name = "FantasticFox1", type = "continuous"), labels = c("Bockstein", "Balve", "Klausennische","Königsaue", "Pradnick", "Buhlen", "undeterminable")) 

 
ggsave("PS.morpho.length_width.png")



```
